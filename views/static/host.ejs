<!doctype html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/dist/umd/i18next.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/i18next-http-backend@4.5.0/dist/umd/i18nextHttpBackend.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Host onboarding</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--accent-1:#ff7a7a;--accent-2:#fe424d;--muted:#6b7280;--bg:#fbfafb;--card:#fff;--radius:14px;--shadow:0 10px 30px rgba(15,23,42,0.06);font-family:Inter,system-ui,Arial,sans-serif}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#0f1724;-webkit-font-smoothing:antialiased}
.container{max-width:1200px;margin:28px auto;padding:18px}
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.brand{display:flex;align-items:center;gap:12px}
.logoMark{width:44px;height:44px;border-radius:10px;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}
.btn{padding:10px 14px;border-radius:12px;border:none;font-weight:700;cursor:pointer;transition:all 0.3s}
.btn.primary{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#fff}
.btn.primary:hover{opacity:0.9}
.btn.ghost{background:transparent;border:1px solid #eef2f7;color:var(--muted)}
.btn.ghost:hover{background:#f3f4f6}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.columns{display:grid;grid-template-columns:1fr 380px;gap:20px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
.muted{color:var(--muted)}
.input, textarea, select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);background:#fff;margin-top:6px;font-family:inherit;font-size:14px}
.input:focus, textarea:focus, select:focus{outline:none;border-color:var(--accent-2);box-shadow:0 0 0 3px rgba(254,66,77,0.1)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.dropzone{border:2px dashed rgba(15,23,42,0.06);padding:16px;border-radius:10px;text-align:center;cursor:pointer;background:#fff;margin-top:6px;transition:all 0.3s}
.dropzone:hover{border-color:var(--accent-2);background:#fff9f9}
.dropzone.dragover{border-color:var(--accent-2);background:linear-gradient(180deg,#fff,#fff9f9)}
.preview-list{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px}
.preview-thumb{width:120px;height:80px;border-radius:10px;overflow:hidden;border:1px solid #f3f4f6;position:relative;background:#fafafa}
.preview-thumb img, .preview-thumb video{width:100%;height:100%;object-fit:cover}
.preview-remove{position:absolute;top:6px;right:6px;background:#111;color:#fff;border:none;border-radius:8px;padding:4px;cursor:pointer;font-size:16px}
.preview-remove:hover{background:#333}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:12px 16px;border-radius:10px;display:none;z-index:9999}
.step-progress{display:flex;gap:12px;margin:12px 0}
.step-progress .pill{flex:1;height:10px;border-radius:999px;background:#f1f1f1;transition:all 0.3s}
.step-progress .pill.active{background:linear-gradient(90deg,var(--accent-1),var(--accent-2))}
.status{display:inline-flex;gap:8px;align-items:center}
.status-dot{width:10px;height:10px;border-radius:50%;transition:all 0.3s}
.status-pending{color:#b45309}
.status-verified{color:#0ea5a4}
.status-dot.pending{background:#f59e0b}
.status-dot.verified{background:#10b981}
.small{font-size:13px;color:var(--muted)}
.activity{max-height:280px;overflow:auto;border-top:1px solid #f3f4f6;margin-top:12px;padding-top:8px}
.action-row{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
.card-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.right-sm{font-size:13px;color:var(--muted)}
.hidden{display:none}
.amenity-tag{display:inline-flex;align-items:center;gap:8px;background:#f3f4f6;padding:6px 10px;border-radius:8px;font-size:14px}
.amenity-tag button{background:transparent;border:none;cursor:pointer;color:var(--muted);padding:0;font-size:16px;line-height:1}
.amenity-tag button:hover{color:#111}
@media(max-width:980px){.columns{grid-template-columns:1fr}.preview-thumb{width:96px;height:72px}}
#propertyMap{width:100%;height:400px;border-radius:10px;margin-top:6px;border:1px solid rgba(15,23,42,0.06);background:#f3f4f6}
.location-suggestions{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #eef2f7;border-radius:10px;max-height:200px;overflow-y:auto;z-index:1000;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
.location-suggestion-item{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f3f4f6}
.location-suggestion-item:hover{background:#f9fafb}

</style>
</head>
<body>
<script>
// Check authentication
(function(){
  const user = <%- typeof session !== 'undefined' && session.supabaseUser ? JSON.stringify(session.supabaseUser) : 'null' %>;
  if (!user || !user.id) {
    window.location.href = '/users/login';
    return;
  }
  window.authenticatedUser = user;
})();

// i18next init
i18next.use(i18nextHttpBackend).use(i18nextBrowserLanguageDetector).init({
  fallbackLng: 'en',
  backend: {loadPath: '/locales/{{lng}}/translation.json'},
  detection: {order: ['localStorage', 'navigator'], caches: ['localStorage']}
}, function(err, t) {
  if (err) console.error('i18next error:', err);
});
</script>

<div id="toast" class="toast"></div>
<div class="container">
  <header class="topbar">
    <div class="brand">
      <div class="logoMark">HV</div>
      <div>
        <div style="font-weight:800">Host onboarding</div>
        <div class="small muted">Complete profile, verify documents & list your place</div>
      </div>
    </div>
    <div style="display:flex;gap:12px;align-items:center">
      <button id="navHost" class="btn ghost">Host</button>
      <button id="navProperty" class="btn ghost">Property</button>
      <button id="navVerify" class="btn ghost">Verification</button>
      <button id="btnPreviewPublic" class="btn primary">Preview</button>
      <select id="languageSelector" class="input" style="width:120px;padding:8px;font-size:14px">
        <option value="en">English</option>
        <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
        <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
      </select>
    </div>
  </header>

  <div class="step-progress" id="progressPills">
    <div class="pill active"></div>
    <div class="pill"></div>
    <div class="pill"></div>
  </div>

  <!-- HOST PAGE -->
  <section id="page-host" class="columns card">
    <main style="padding:18px">
      <div class="card-title"><h2 style="margin:0">Host details</h2><div class="right-sm">Step 1</div></div>
      <p class="small muted">Add contact info and profile photo.</p>
      <form id="hostForm" onsubmit="return false" autocomplete="off">
        <div class="grid-2">
          <div>
            <label>First name <input id="hostFirstName" class="input" required></label>
            <label>Last name <input id="hostLastName" class="input" required></label>
            <label>Email <input id="hostEmail" class="input" type="email" required></label>
            <label>Phone <input id="hostPhone" class="input" type="tel" required></label>
            <label>Date of Birth <input id="hostDOB" class="input" type="date" required></label>
            <label>Gender <select id="hostGender" class="input"><option value="">Select</option><option value="male">Male</option><option value="female">Female</option><option value="other">Other</option><option value="prefer-not-to-say">Prefer not to say</option></select></label>
          </div>
          <div>
            <label>Profile photo</label>
            <div id="avatarDrop" class="dropzone">Click or drop photo (‚â§2MB)</div>
            <input id="hostProfilePhoto" type="file" accept="image/*" style="display:none">
            <div id="previewHostPhoto" class="preview-list"></div>
          </div>
        </div>
        <label style="margin-top:12px">Short bio <textarea id="hostBio" class="input" placeholder="Introduce yourself"></textarea></label>
        <div style="margin-top:12px;padding:12px;border-radius:10px;background:#f9fafb;border:1px solid #e5e7eb">
          <h4 style="margin:0 0 12px">Address Information</h4>
          <label>Full Address <input id="hostAddress" class="input" placeholder="Street address" required></label>
          <div class="grid-2" style="margin-top:10px">
            <label>City <input id="hostCity" class="input" required></label>
            <label>State <input id="hostState" class="input" required></label>
          </div>
          <div class="grid-2" style="margin-top:10px">
            <label>PIN Code <input id="hostPinCode" class="input" required></label>
          </div>
        </div>
        <div class="action-row">
          <button id="hostSave" type="button" class="btn ghost">Save draft</button>
          <button id="toProperty" type="button" class="btn primary">Next: Property</button>
        </div>
      </form>
    </main>
    <aside class="card" style="padding:18px">
      <h3 style="margin-top:0">Preview</h3>
      <div id="hostPreviewMain" class="preview-list" style="min-height:120px;align-items:center;display:flex;justify-content:center">No photo</div>
      <div style="margin-top:12px">
        <div id="previewHostName" style="font-weight:700">Your name</div>
        <div id="previewHostBio" class="small muted">Bio will appear here</div>
      </div>
    </aside>
  </section>

  <!-- PROPERTY PAGE -->
  <section id="page-property" class="columns card hidden">
    <main style="padding:18px">
      <div class="card-title"><h2 style="margin:0">Property details</h2><div class="right-sm">Step 2</div></div>
      <p class="small muted">Add listing details and upload photos/video.</p>
      <form id="propertyForm" onsubmit="return false">
        <div class="grid-2">
          <label>Property type <select id="propertyType" class="input"><option value="">Select</option><option value="entire">Entire place</option><option value="private">Private room</option></select></label>
          <label>Guests <select id="guests" class="input"><option>1</option><option>2</option><option>3</option><option>4</option><option>5+</option></select></label>
        </div>
        <label style="margin-top:10px">Title <input id="title" class="input" maxlength="80" placeholder="2BR apartment"></label>
        <div class="grid-2" style="margin-top:10px">
          <label>Price (INR) <input id="price" type="number" class="input" placeholder="1200"></label>
          <label>Cancellation <select id="cancellation" class="input"><option value="flexible">Flexible</option><option value="moderate">Moderate</option><option value="strict">Strict</option></select></label>
        </div>
        <div style="margin-top:12px;position:relative">
          <label>Property Location <input id="propertyLocation" class="input" placeholder="Enter your property address" required></label>
          <div id="locationSuggestions" class="location-suggestions" style="display:none"></div>
          <div id="propertyMap"></div>
          <div id="locationCoords" style="margin-top:6px;font-size:13px;color:var(--muted)">Coordinates: <span id="coordsDisplay">Not set</span></div>
        </div>
        <div style="margin-top:12px">
          <label class="small">Amenities</label>
          <div style="display:flex;gap:8px;margin-top:6px">
            <input id="amenityInput" class="input" placeholder="e.g. WiFi, AC" style="flex:1">
            <button id="addAmenityBtn" type="button" class="btn ghost">Add</button>
          </div>
          <div id="amenitiesContainer" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;padding:12px;border-radius:10px;background:#fff;border:1px solid rgba(15,23,42,0.06);min-height:48px"></div>
        </div>
        <section style="margin-top:14px" class="card">
          <h4 style="margin:0 0 8px">Photos & video</h4>
          <div class="small muted">Up to 8 images (‚â§4MB) and 1 video (‚â§20MB).</div>
          <div style="margin-top:12px">
            <div id="imageDrop" class="dropzone">Click or drop images</div>
            <input id="propertyImages" type="file" accept="image/*" multiple style="display:none">
            <div id="imagePreview" class="preview-list"></div>
          </div>
          <div style="margin-top:12px">
            <div id="videoDrop" class="dropzone">Click or drop video</div>
            <input id="propertyVideo" type="file" accept="video/*" style="display:none">
            <div id="videoPreview" class="preview-list"></div>
          </div>
        </section>
        <div class="action-row" style="margin-top:12px">
          <button id="savePropertyDraft" type="button" class="btn ghost">Save draft</button>
          <button id="goVerify" type="button" class="btn primary">Next: Verification</button>
        </div>
      </form>
    </main>
    <aside class="card" style="padding:18px">
      <h3 style="margin-top:0">Preview</h3>
      <div id="mainPreviewPhoto" class="preview-list" style="min-height:120px;align-items:center;display:flex;justify-content:center">No photo</div>
      <div style="margin-top:12px">
        <div id="previewTitle" style="font-weight:700">Title here</div>
        <div id="previewSub" class="small muted">Property ‚Ä¢ Guests</div>
        <div id="previewCounts" class="small muted">0 photos ‚Ä¢ 0 videos</div>
        <div id="previewPrice" class="small muted">Price: ‚Äî</div>
      </div>
    </aside>
  </section>

  <!-- VERIFICATION PAGE -->
  <section id="page-verify" class="columns card hidden">
    <main style="padding:18px">
      <div class="card-title"><h2 style="margin:0">Verification</h2><div class="right-sm">Step 3</div></div>
      <p class="small muted">Upload ID and bank details.</p>
      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px">ID Verification</h4>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:320px">
            <label>ID type <select id="v_idType" class="input"><option value="">Select</option><option value="aadhaar">Aadhaar</option><option value="pan">PAN Card</option><option value="passport">Passport</option><option value="driving">Driving Licence</option></select></label>
            <label style="margin-top:8px">ID number <input id="v_idNumber" class="input" placeholder="ID number"></label>
            <div style="display:flex;gap:8px;margin-top:8px">
              <div style="flex:1">
                <div class="small">Front</div>
                <div id="v_idFrontDrop" class="dropzone">Click or drop</div>
                <input id="v_idFrontFile" type="file" accept="image/*,application/pdf" style="display:none">
                <div id="v_idFrontHint" class="small muted" style="margin-top:4px"></div>
              </div>
              <div style="flex:1">
                <div class="small">Back (optional)</div>
                <div id="v_idBackDrop" class="dropzone">Click or drop</div>
                <input id="v_idBackFile" type="file" accept="image/*,application/pdf" style="display:none">
                <div id="v_idBackHint" class="small muted" style="margin-top:4px"></div>
              </div>
            </div>
            <div class="action-row" style="margin-top:12px">
              <button id="v_submitId" type="button" class="btn primary">Submit ID</button>
              <button id="v_resubmitId" type="button" class="btn ghost">Clear</button>
            </div>
          </div>
          <aside style="width:360px">
            <div class="card">
              <h4 style="margin-top:0">Status</h4>
              <div class="status"><span id="idStatusDot" class="status-dot pending"></span> <strong id="idStatusText" class="status-pending">Not submitted</strong></div>
              <div class="small muted" id="idStatusDesc">Upload ID to start.</div>
              <div class="activity" id="idActivity"></div>
            </div>
          </aside>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px">Bank Verification</h4>
        <div class="grid-2" style="margin-top:8px">
          <label>Account holder <input id="v_acctHolder" class="input"></label>
          <label>Account number <input id="v_bankAccount" class="input"></label>
        </div>
        <div class="grid-2" style="margin-top:8px">
          <label>IFSC <input id="v_ifsc" class="input" placeholder="HDFC0001234"></label>
          <div style="padding-top:6px"><button id="v_verifyBank" type="button" class="btn primary">Verify</button></div>
        </div>
        <div style="display:flex;gap:12px;margin-top:10px;flex-wrap:wrap">
          <div><strong>Bank:</strong> <span id="v_bankName" class="small muted">‚Äî</span></div>
          <div><strong>Branch:</strong> <span id="v_branchName" class="small muted">‚Äî</span></div>
          <div style="flex:1;text-align:right"><strong>Status:</strong> <span id="v_bankStatus" class="small status-pending">Not verified</span></div>
        </div>
      </div>
      <div style="margin-top:12px" class="card">
        <h4 style="margin:0 0 8px">Complete Onboarding</h4>
        <ol class="small muted" style="margin:8px 0 12px">
          <li>Submit clear ID photos</li>
          <li>Verify bank account</li>
          <li>Click Done to complete</li>
        </ol>
        <div class="action-row">
          <button id="v_backToProperty" type="button" class="btn ghost">Back</button>
          <button id="v_done" type="button" class="btn primary">Complete</button>
        </div>
      </div>
    </main>
    <aside class="card">
      <h3 style="margin-top:0">Log</h3>
      <div id="verificationActivity" class="activity"></div>
    </aside>
  </section>

</div>

<script src="https://checkout.razorpay.com/v1/checkout.js" async></script>
<script>
(function(){
  const $ = id => document.getElementById(id);
  const toast = $('toast');

  function showToast(msg, duration=2200){
    toast.textContent = msg;
    toast.style.display = 'block';
    clearTimeout(toast._timeout);
    toast._timeout = setTimeout(() => toast.style.display = 'none', duration);
  }

  const pages = {host: $('page-host'), property: $('page-property'), verify: $('page-verify')};
  const pills = Array.from(document.querySelectorAll('.step-progress .pill'));

  function showPage(name, push=true){
    Object.keys(pages).forEach(k => pages[k].classList.toggle('hidden', k !== name));
    const idxMap = {host:0, property:1, verify:2};
    pills.forEach((p,i) => p.classList.toggle('active', i <= idxMap[name]));
    if (push) {
      const urls = {host: '/host-details', property: '/property-details', verify: '/host-verify'};
      history.pushState({page:name}, '', urls[name]);
    }
  }

  window.addEventListener('popstate', e => showPage((e.state && e.state.page) || 'host', false));

  $('navHost').addEventListener('click', () => showPage('host'));
  $('navProperty').addEventListener('click', () => showPage('property'));
  $('navVerify').addEventListener('click', () => showPage('verify'));

  const pathname = location.pathname;
  if (pathname.includes('verify')) showPage('verify', false);
  else if (pathname.includes('property')) showPage('property', false);
  else showPage('host', false);

  // HOST PAGE
  (function(){
    const avatarDrop = $('avatarDrop'), avatarInput = $('hostProfilePhoto'), previewHostPhoto = $('previewHostPhoto');
    avatarDrop.addEventListener('click', () => avatarInput.click());
    avatarInput.addEventListener('change', e => {
      const file = e.target.files?.[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) { showToast('Upload an image'); return; }
      if (file.size > 2*1024*1024) { showToast('Max 2MB'); return; }
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.style.cssText = 'width:120px;height:120px;object-fit:cover;border-radius:10px';
      previewHostPhoto.innerHTML = '';
      previewHostPhoto.appendChild(img);
      avatarDrop._file = file;
      showToast('Photo uploaded');
    });

    ['hostFirstName', 'hostLastName', 'hostBio', 'hostAddress', 'hostCity', 'hostState', 'hostPinCode', 'hostDOB', 'hostGender'].forEach(id => {
      const el = $(id);
      if (el) el.addEventListener('input', () => {
        $('previewHostName').textContent = ($('hostFirstName').value || '') + ($('hostLastName').value ? ' ' + $('hostLastName').value : '') || 'Your name';
        $('previewHostBio').textContent = $('hostBio').value || 'Bio here';
      });
    });

    $('hostSave').addEventListener('click', e => {
      e.preventDefault();
      const draft = {
        firstName: $('hostFirstName').value,
        lastName: $('hostLastName').value,
        email: $('hostEmail').value,
        phone: $('hostPhone').value,
        bio: $('hostBio').value,
        dateOfBirth: $('hostDOB').value,
        gender: $('hostGender').value,
        address: $('hostAddress').value,
        city: $('hostCity').value,
        state: $('hostState').value,
        pinCode: $('hostPinCode').value
      };
      localStorage.setItem('hostDraft', JSON.stringify(draft));
      showToast('Draft saved');
    });

    $('toProperty').addEventListener('click', () => {
      if (!$('hostFirstName').value.trim() || !$('hostEmail').value.trim() || !$('hostPhone').value.trim() || !$('hostDOB').value || !$('hostAddress').value.trim() || !$('hostCity').value.trim() || !$('hostState').value.trim() || !$('hostPinCode').value.trim()) { showToast('Fill all required fields'); return; }
      const draft = {
        firstName: $('hostFirstName').value,
        lastName: $('hostLastName').value,
        email: $('hostEmail').value,
        phone: $('hostPhone').value,
        bio: $('hostBio').value,
        dateOfBirth: $('hostDOB').value,
        gender: $('hostGender').value,
        address: $('hostAddress').value,
        city: $('hostCity').value,
        state: $('hostState').value,
        pinCode: $('hostPinCode').value
      };
      try { localStorage.setItem('hostDraft', JSON.stringify(draft)); } catch(e) {}
      showPage('property');
    });

    try {
      const saved = localStorage.getItem('hostDraft');
      if (saved) {
        const data = JSON.parse(saved);
        $('hostFirstName').value = data.firstName || '';
        $('hostLastName').value = data.lastName || '';
        $('hostEmail').value = data.email || '';
        $('hostPhone').value = data.phone || '';
        $('hostBio').value = data.bio || '';
        $('hostDOB').value = data.dateOfBirth || '';
        $('hostGender').value = data.gender || '';
        $('hostAddress').value = data.address || '';
        $('hostCity').value = data.city || '';
        $('hostState').value = data.state || '';
        $('hostPinCode').value = data.pinCode || '';
        $('previewHostName').textContent = (data.firstName || '') + (data.lastName ? ' ' + data.lastName : '') || 'Your name';
        $('previewHostBio').textContent = data.bio || 'Bio here';
      }
    } catch(e) {}
  })();

  // PROPERTY PAGE
  (function(){
    let map, marker, propertyCoordinates = null;

    // Initialize map
    function initMap(){
      if (!map) {
        map = L.map('propertyMap').setView([20.5937, 78.9629], 4); // Center on India
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors',
          maxZoom: 19
        }).addTo(map);
      }
    }

    // Geocode location using Nominatim
    const locationInput = $('propertyLocation');
    const suggestionsBox = $('locationSuggestions');
    let suggestionsTimeout;

    locationInput.addEventListener('input', async e => {
      const query = e.target.value.trim();
      if (query.length < 3) { suggestionsBox.style.display = 'none'; return; }

      clearTimeout(suggestionsTimeout);
      suggestionsTimeout = setTimeout(async () => {
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5`);
          const results = await res.json();

          suggestionsBox.innerHTML = '';
          if (results.length === 0) { suggestionsBox.style.display = 'none'; return; }

          results.forEach(r => {
            const item = document.createElement('div');
            item.className = 'location-suggestion-item';
            item.textContent = r.display_name;
            item.onclick = () => selectLocation(r);
            suggestionsBox.appendChild(item);
          });
          suggestionsBox.style.display = 'block';
        } catch(err) { console.error('Geocoding error:', err); }
      }, 300);
    });

    function selectLocation(result){
      const lat = parseFloat(result.lat);
      const lon = parseFloat(result.lon);
      locationInput.value = result.display_name;
      propertyCoordinates = {latitude: lat, longitude: lon, address: result.display_name};

      $('coordsDisplay').textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
      suggestionsBox.style.display = 'none';

      // Update map
      initMap();
      map.setView([lat, lon], 13);
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lon]).addTo(map).bindPopup(result.display_name);
    }

    // Hide suggestions when clicking outside
    document.addEventListener('click', e => {
      if (e.target !== locationInput) suggestionsBox.style.display = 'none';
    });

    function wireDrop(dropId, inputId, previewId, isMultiple, maxSize){
      const drop = $(dropId), input = $(inputId), preview = $(previewId);
      let files = [];

      function render(){
        preview.innerHTML = '';
        files.forEach((f, i) => {
          const url = URL.createObjectURL(f);
          const div = document.createElement('div');
          div.className = 'preview-thumb';
          const elem = isMultiple ? document.createElement('img') : document.createElement('video');
          elem.src = url;
          if (!isMultiple) elem.controls = true;
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'preview-remove';
          btn.textContent = '‚úï';
          btn.onclick = e => { e.preventDefault(); files.splice(i, 1); render(); updateMeta(); };
          div.appendChild(elem);
          div.appendChild(btn);
          preview.appendChild(div);
        });
        updateMeta();
      }

      if (drop) {
        drop.addEventListener('click', () => input.click());
        ['dragenter', 'dragover'].forEach(e => drop.addEventListener(e, ev => { ev.preventDefault(); drop.classList.add('dragover'); }));
        ['dragleave', 'drop'].forEach(e => drop.addEventListener(e, ev => { ev.preventDefault(); drop.classList.remove('dragover'); }));
        drop.addEventListener('drop', e => { e.preventDefault(); handle(e.dataTransfer.files); });
      }

      input.addEventListener('change', e => handle(e.target.files));

      function handle(list){
        for (let f of list) {
          if (isMultiple && !f.type.startsWith('image/')) continue;
          if (!isMultiple && !f.type.startsWith('video/')) continue;
          if (f.size > maxSize) { showToast('File too large'); continue; }
          if (isMultiple && files.length >= 8) break;
          files.push(f);
          if (!isMultiple) break;
        }
        render();
      }

      return {getFiles: () => files, getFile: () => files[0] || null};
    }

    const imgs = wireDrop('imageDrop', 'propertyImages', 'imagePreview', true, 4*1024*1024);
    const vid = wireDrop('videoDrop', 'propertyVideo', 'videoPreview', false, 20*1024*1024);

    const title = $('title'), pType = $('propertyType'), guests = $('guests'), price = $('price');
    const amenityInput = $('amenityInput'), addAmenityBtn = $('addAmenityBtn'), amenitiesContainer = $('amenitiesContainer');
    let amenities = [];

    function renderAmenities(){
      amenitiesContainer.innerHTML = '';
      amenities.forEach((a, i) => {
        const tag = document.createElement('div');
        tag.className = 'amenity-tag';
        tag.textContent = a;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.innerHTML = '&times;';
        btn.style.marginLeft = 'auto';
        btn.onclick = e => { e.preventDefault(); amenities.splice(i, 1); renderAmenities(); };
        tag.appendChild(btn);
        amenitiesContainer.appendChild(tag);
      });
    }

    function addAmenity(){
      const text = amenityInput.value.trim();
      if (!text) return;
      if (amenities.includes(text)) { showToast('Already added'); return; }
      if (amenities.length >= 20) { showToast('Max 20'); return; }
      amenities.push(text);
      amenityInput.value = '';
      renderAmenities();
      amenityInput.focus();
    }

    addAmenityBtn.addEventListener('click', e => { e.preventDefault(); addAmenity(); });
    amenityInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); addAmenity(); } });

    function updateMeta(){
      $('previewTitle').textContent = title.value.trim() || 'Title';
      $('previewSub').textContent = (pType.value || 'Property') + ' ‚Ä¢ ' + (guests.value || '‚Äî') + ' guests';
      $('previewCounts').textContent = `${imgs.getFiles().length} photos ‚Ä¢ ${vid.getFile() ? 1 : 0} videos`;
      $('previewPrice').textContent = price.value ? ('Price: ‚Çπ' + price.value) : 'Price: ‚Äî';
      const mainBox = $('mainPreviewPhoto');
      if (imgs.getFiles().length > 0) {
        mainBox.innerHTML = '';
        const im = document.createElement('img');
        im.src = URL.createObjectURL(imgs.getFiles()[0]);
        im.style.cssText = 'width:100%;height:100%;object-fit:cover';
        mainBox.appendChild(im);
      } else mainBox.innerHTML = 'No photo';
    }

    [title, pType, guests, price].forEach(el => { if (el) el.addEventListener('input', updateMeta); });

    $('savePropertyDraft').addEventListener('click', e => {
      e.preventDefault();
      const draft = {title: title.value, propertyType: pType.value, guests: guests.value, price: price.value, cancellation: $('cancellation').value, amenities: amenities, location: propertyCoordinates};
      localStorage.setItem('propertyDraft', JSON.stringify(draft));
      showToast('Draft saved');
    });

    $('goVerify').addEventListener('click', () => {
      if (!propertyCoordinates) { showToast('Please select a property location on the map'); return; }
      showPage('verify');
    });

    try {
      const saved = localStorage.getItem('propertyDraft');
      if (saved) {
        const data = JSON.parse(saved);
        title.value = data.title || '';
        pType.value = data.propertyType || '';
        guests.value = data.guests || '1';
        price.value = data.price || '';
        $('cancellation').value = data.cancellation || 'flexible';
        if (Array.isArray(data.amenities)) { amenities = data.amenities; renderAmenities(); }

        // Restore location and map
        if (data.location) {
          propertyCoordinates = data.location;
          locationInput.value = data.location.address || '';
          $('coordsDisplay').textContent = `${data.location.latitude.toFixed(4)}, ${data.location.longitude.toFixed(4)}`;
          initMap();
          map.setView([data.location.latitude, data.location.longitude], 13);
          if (marker) map.removeLayer(marker);
          marker = L.marker([data.location.latitude, data.location.longitude]).addTo(map).bindPopup(data.location.address);
        }

        updateMeta();
      }
    } catch(e) {}

    // ‚úÖ FIX 1: Store location in window._propertyData
    window._propertyData = {
      imgs,
      vid,
      amenities: () => amenities,
      location: propertyCoordinates,  // ‚úÖ CRITICAL FIX
      getLocation: () => propertyCoordinates  // ‚úÖ Helper function
    };
  })();

  // VERIFICATION PAGE
  (function(){
    function logActivity(containerId, text){
      const c = $(containerId);
      if (!c) return;
      const el = document.createElement('div');
      el.style.cssText = 'padding:8px 6px;border-bottom:1px solid #f3f4f6';
      el.innerHTML = `<div style="font-size:13px">${text}</div><div class="small muted">${new Date().toLocaleString()}</div>`;
      c.prepend(el);
    }

    function wireDrop(dropId, inputId, hintId, maxBytes=5*1024*1024){
      const drop = $(dropId), input = $(inputId), hint = $(hintId);
      drop.addEventListener('click', () => input.click());
      ['dragenter', 'dragover'].forEach(e => drop.addEventListener(e, ev => { ev.preventDefault(); drop.classList.add('dragover'); }));
      ['dragleave', 'drop'].forEach(e => drop.addEventListener(e, ev => { ev.preventDefault(); drop.classList.remove('dragover'); }));
      drop.addEventListener('drop', e => { e.preventDefault(); handle(e.dataTransfer.files); });
      input.addEventListener('change', () => handle(input.files));

      function handle(list){
        const f = list?.[0];
        if (!f) return;
        const isValid = f.type.startsWith('image/') || f.type === 'application/pdf';
        if (!isValid) { showToast('Use JPG, PNG or PDF'); return; }
        if (f.size > maxBytes) { showToast('File too large'); return; }
        drop._file = f;
        hint.textContent = `‚úì ${f.name} (${(f.size/1024).toFixed(1)}KB)`;
        logActivity('idActivity', `Uploaded: ${f.name}`);
      }
    }

    wireDrop('v_idFrontDrop', 'v_idFrontFile', 'v_idFrontHint');
    wireDrop('v_idBackDrop', 'v_idBackFile', 'v_idBackHint');

    $('v_submitId').addEventListener('click', async e => {
      e.preventDefault();
      const type = $('v_idType').value, num = $('v_idNumber').value.trim(), front = $('v_idFrontDrop')._file;
      if (!type || !num || !front) { showToast('Fill all fields'); return; }

      const btn = $('v_submitId');
      btn.disabled = true;
      btn.textContent = 'Submitting...';

      try {
        const fd = new FormData();
        fd.append('idType', type);
        fd.append('idNumber', num);
        fd.append('idFront', front);
        if ($('v_idBackDrop')._file) fd.append('idBack', $('v_idBackDrop')._file);

        const res = await fetch('/host/verify-id', {method: 'POST', body: fd, credentials: 'include'});
        if (res.status === 401) { window.location.href = '/users/login'; return; }

        const data = await res.json().catch(() => ({}));
        if (res.ok) { showToast('ID submitted'); $('idStatusText').textContent = 'Pending'; $('idStatusDot').className = 'status-dot pending'; logActivity('idActivity', 'ID submitted'); }
        else showToast(data.message || 'Failed');
      } catch(err) { showToast('Error: ' + err.message); }
      finally { btn.disabled = false; btn.textContent = 'Submit ID'; }
    });

    $('v_resubmitId').addEventListener('click', e => {
      e.preventDefault();
      $('v_idType').value = '';
      $('v_idNumber').value = '';
      $('v_idFrontDrop')._file = null;
      $('v_idBackDrop')._file = null;
      $('v_idFrontHint').textContent = '';
      $('v_idBackHint').textContent = '';
      showToast('Cleared');
    });

    $('v_ifsc').addEventListener('blur', async () => {
      const code = $('v_ifsc').value.trim().toUpperCase();
      if (!code) return;
      if (!/^[A-Z]{4}0[A-Z0-9]{6}$/.test(code)) { $('v_bankName').textContent = '‚Äî'; $('v_bankStatus').textContent = 'Invalid'; return; }
      $('v_bankStatus').textContent = 'Verifying...';
      try {
        const res = await fetch('https://ifsc.razorpay.com/' + code);
        if (!res.ok) { $('v_bankStatus').textContent = 'Not found'; return; }
        const data = await res.json();
        $('v_bankName').textContent = data.BANK || '‚Äî';
        $('v_branchName').textContent = data.BRANCH || '‚Äî';
        $('v_bankStatus').textContent = 'Verified ‚úì';
        $('v_bankStatus').className = 'small status-verified';
        logActivity('verificationActivity', 'IFSC verified');
      } catch(err) { $('v_bankStatus').textContent = 'Failed'; }
    });

    $('v_verifyBank').addEventListener('click', async e => {
      e.preventDefault();
      const acct = $('v_bankAccount').value.trim(), ifsc = $('v_ifsc').value.trim(), holder = $('v_acctHolder').value.trim();
      const bankName = $('v_bankName').textContent.trim() === '‚Äî' ? 'Verified' : $('v_bankName').textContent.trim();
      const branchName = $('v_branchName').textContent.trim() === '‚Äî' ? 'Verified' : $('v_branchName').textContent.trim();

      if (!acct || !ifsc || !holder) { showToast('Fill all fields'); return; }

      const btn = $('v_verifyBank');
      btn.disabled = true;
      btn.textContent = 'Verifying...';

      try {
        const res = await fetch('/host/verify-bank', {method: 'POST', headers: {'Content-Type': 'application/json'}, credentials: 'include', body: JSON.stringify({accountHolder: holder, accountNumber: acct, ifscCode: ifsc, bankName, branchName})});
        const data = await res.json().catch(() => ({}));
        if (res.ok) { showToast('Bank verified'); $('v_bankStatus').textContent = 'Verified ‚úì'; $('v_bankStatus').className = 'small status-verified'; logActivity('verificationActivity', 'Bank verified'); }
        else showToast(data.message || 'Failed');
      } catch(err) { showToast('Error'); }
      finally { btn.disabled = false; btn.textContent = 'Verify'; }
    });

    $('v_backToProperty').addEventListener('click', () => showPage('property'));

    // ‚úÖ FIX 2: Read DIRECTLY from form fields instead of localStorage
    $('v_done').addEventListener('click', async e => {
      e.preventDefault();
      const btn = $('v_done');
      btn.disabled = true;
      btn.textContent = 'Submitting...';

      try {
        const hostDraft = JSON.parse(localStorage.getItem('hostDraft') || '{}');

        // ‚úÖ CRITICAL FIX: Read directly from form fields
        const fd = new FormData();

        // Host details from localStorage (already saved)
        fd.append('hostFirstName', hostDraft.firstName || '');
        fd.append('hostLastName', hostDraft.lastName || '');
        fd.append('hostEmail', hostDraft.email || '');
        fd.append('hostPhone', hostDraft.phone || '');
        fd.append('hostBio', hostDraft.bio || '');
        fd.append('hostDOB', hostDraft.dateOfBirth || '');
        fd.append('hostGender', hostDraft.gender || '');
        fd.append('hostAddress', hostDraft.address || '');
        fd.append('hostCity', hostDraft.city || '');
        fd.append('hostState', hostDraft.state || '');
        fd.append('hostPinCode', hostDraft.pinCode || '');

        if ($('avatarDrop')._file) fd.append('hostProfilePhoto', $('avatarDrop')._file);

        // ‚úÖ Property details - Read from FORM INPUTS not localStorage!
        const titleValue = $('title').value.trim();
        const propertyTypeValue = $('propertyType').value.trim();
        const guestsValue = $('guests').value.trim();
        const priceValue = $('price').value.trim();
        const cancellationValue = $('cancellation').value.trim();

        console.log('üìã Reading form values:', {
          title: titleValue,
          propertyType: propertyTypeValue,
          guests: guestsValue,
          price: priceValue
        });

        fd.append('title', titleValue);
        fd.append('propertyType', propertyTypeValue);
        fd.append('guests', guestsValue || '1');
        fd.append('price', priceValue);
        fd.append('cancellation', cancellationValue || 'flexible');

        // ‚úÖ Location data
        const locData = window._propertyData?.getLocation ? window._propertyData.getLocation() : window._propertyData?.location;
        if (locData) {
          fd.append('propertyLatitude', locData.latitude);
          fd.append('propertyLongitude', locData.longitude);
          fd.append('propertyLocationAddress', locData.address);
          console.log('üìç Location:', locData);
        }

        // ‚úÖ Amenities
        if (window._propertyData && window._propertyData.amenities) {
          const amen = window._propertyData.amenities();
          amen.forEach(a => fd.append('amenities', a));
          console.log('üè∑Ô∏è Amenities:', amen);
        }

        // ‚úÖ Images
        if (window._propertyData && window._propertyData.imgs) {
          const imgs = window._propertyData.imgs.getFiles();
          imgs.forEach(f => fd.append('propertyImages', f));
          console.log('üñºÔ∏è Images:', imgs.length);
        }

        // ‚úÖ Video
        if (window._propertyData && window._propertyData.vid) {
          const vf = window._propertyData.vid.getFile();
          if (vf) {
            fd.append('propertyVideo', vf);
            console.log('üé• Video:', vf.name);
          }
        }

        console.log('üì§ Submitting to /host/onboarding-complete');
        const res = await fetch('/host/onboarding-complete', {
          method: 'POST',
          body: fd,
          credentials: 'include'
        });

        const result = await res.json().catch(() => ({}));
        console.log('üì• Server response:', result);

        if (res.status === 401) {
          window.location.href = '/users/login';
          return;
        }

        if (res.ok && result.success) {
          showToast('Success! Redirecting...');
          localStorage.removeItem('hostDraft');
          localStorage.removeItem('propertyDraft');
          setTimeout(() => window.location.href = '/users/dashboard', 2000);
        } else {
          showToast(result.message || 'Failed');
          console.error('‚ùå Submission failed:', result);
        }
      } catch(err) {
        console.error('üí• Error:', err);
        showToast('Error: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Complete';
      }
    });
  })();

})();
</script>

</body>
</html>
