<% layout('/layouts/boilerplate') %>
<link rel="stylesheet" href="/css/payment.css" />

<div class="payment-container">
  <div class="row">
    <div class="col-md-6 order-md-2 payment-summary">
      <h4 class="d-flex justify-content-between align-items-center mb-3">
        <span class="text-muted">Booking Summary</span>
      </h4>
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <% if(listing.image && listing.image.url) { %>
              <img src="<%= listing.image.url %>" class="img-fluid rounded me-3" alt="<%= listing.title %>" style="width: 100px; height: 100px; object-fit: cover;">
            <% } %>
            <div>
              <h5 class="card-title mb-1"><%= listing.title %></h5>
              <p class="card-text text-muted"><%= listing.location %>, <%= listing.country %></p>
            </div>
          </div>
          <hr>
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between lh-condensed">
              <div>
                <h6 class="my-0">Check-in</h6>
                <small class="text-muted"><%= new Date(checkIn).toDateString() %></small>
              </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
              <div>
                <h6 class="my-0">Check-out</h6>
                <small class="text-muted"><%= new Date(checkOut).toDateString() %></small>
              </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
              <div>
                <h6 class="my-0">Guests</h6>
                <small class="text-muted"><%= guests %> guest(s)</small>
              </div>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Subtotal</span>
              <strong>₹<%= subtotal.toLocaleString("en-IN") %></strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>GST (12%)</span>
              <strong>₹<%= (totalAmount - subtotal).toLocaleString("en-IN") %></strong>
            </li>
            <li class="list-group-item d-flex justify-content-between bg-light">
              <span class="text-success">Total (INR)</span>
              <strong class="text-success">₹<%= totalAmount.toLocaleString("en-IN") %></strong>
            </li>
          </ul>
        </div>
      </div>
       <div class="trust-seals">
        <i class="fas fa-shield-alt"></i> 100% Secure Payments
      </div>
    </div>
    <div class="col-md-6 order-md-1">
      <h4 class="mb-3">Confirm and Pay</h4>
      <p class="text-muted">You are just a step away from booking your stay. Please review the details and proceed to payment.</p>

      <div class="payment-card">
        <h5>Payment Details</h5>
        <p>You will be redirected to Razorpay for a secure payment.</p>

        <form id="payment-form" method="POST" action="/verify-payment">
          <input type="hidden" name="listingId" value="<%= listing._id %>">
          <input type="hidden" name="checkIn" value="<%= checkIn %>">
          <input type="hidden" name="checkOut" value="<%= checkOut %>">
          <input type="hidden" name="guests" value="<%= guests %>">
          <input type="hidden" name="totalAmount" value="<%= totalAmount %>">
          <input type="hidden" name="razorpay_payment_id" id="razorpay_payment_id">
          <input type="hidden" name="razorpay_order_id" id="razorpay_order_id">
          <input type="hidden" name="razorpay_signature" id="razorpay_signature">

          <button id="pay-btn" class="btn btn-primary btn-lg btn-block" type="button">Pay ₹<%= totalAmount.toLocaleString("en-IN") %></button>
        </form>
        <div class="razorpay-logo">
          <span>Powered by</span>
          <img src="https://razorpay.com/assets/razorpay-logo.svg" alt="Razorpay">
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  document.getElementById('pay-btn').onclick = async function (e) {
    const payBtn = e.target;
    payBtn.disabled = true;
    payBtn.innerHTML = 'Processing...';

    const response = await fetch('/create-order', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        listingId: '<%= listing._id %>',
        checkIn: '<%= checkIn %>',
        checkOut: '<%= checkOut %>',
        guests: '<%= guests %>',
      }),
    });

    const order = await response.json();

    const options = {
      key: '<%= razorpayKeyId %>',
      amount: order.amount,
      currency: order.currency,
      name: 'HomyHive',
      description: 'Booking Payment',
      image: '/images/logo.png', // Add your logo here
      order_id: order.id,
      handler: function (response) {
        document.getElementById('razorpay_payment_id').value = response.razorpay_payment_id;
        document.getElementById('razorpay_order_id').value = response.razorpay_order_id;
        document.getElementById('razorpay_signature').value = response.razorpay_signature;
        document.getElementById('payment-form').submit();
      },
      prefill: {
        name: '<%= currUser ? currUser.displayName : "" %>',
        email: '<%= currUser ? currUser.email : "" %>',
      },
      notes: {
        listing_id: '<%= listing._id %>',
      },
      theme: {
        color: '#fe424d',
      },
      modal: {
        ondismiss: function() {
          payBtn.disabled = false;
          payBtn.innerHTML = 'Pay ₹<%= totalAmount.toLocaleString("en-IN") %>';
        }
      }
    };

    const rzp = new Razorpay(options);
    rzp.open();
  };
</script>
