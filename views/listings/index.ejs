<% layout("/layouts/boilerplate") %>

<div class="page-content">

  <!-- ================= SEARCH BAR ================= -->
  <div class="search-wrapper">
    <form method="GET" action="/listings" class="search-bar">
      <input type="text" name="search" placeholder="Where do you want to go?"
        value="<%= searchQuery || '' %>" />
      <input type="number" name="minPrice" placeholder="Min" />
      <input type="number" name="maxPrice" placeholder="Max" />
      <select name="guests">
        <option value="">Guests</option>
        <option value="1">1+</option>
        <option value="2">2+</option>
        <option value="4">4+</option>
      </select>
      <button type="submit">
        <i class="fa-solid fa-magnifying-glass"></i>
        <span class="btn-text">Search</span>
      </button>
    </form>
  </div>

  <!-- ================= CATEGORY + GST ================= -->
  <div class="category-wrapper">
    <div class="category-scroll" id="categoryNavbar"></div>

    <div class="gst-toggle">
      <input type="checkbox" id="gstToggle" />
      <label for="gstToggle">Display total after taxes</label>
    </div>
  </div>

  <!-- ================= LISTINGS ================= -->
  <div class="container-fluid px-4">
    <div class="listing-grid">

      <% if (regularListings && regularListings.length > 0) { %>
        <% for (let listing of regularListings) { %>

          <div class="listing-card" data-price="<%= listing.price %>">

            <!-- Wishlist -->
            <button class="like-btn">
              <i class="fa-regular fa-heart"></i>
            </button>

            <!-- Image -->
            <div class="image-wrapper">
              <img src="<%= listing.images?.[0]?.url || '/images/no-image.jpg' %>" />
              <div class="image-dots">
                <span class="active"></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <!-- Body -->
            <div class="card-body">
              <h5 class="title"><%= listing.title %></h5>
              <p class="location">
                <i class="fa-solid fa-location-dot"></i>
                <%= listing.location %>, <%= listing.country %>
              </p>
              <p class="price">
                â‚¹<span class="price-value"><%= listing.price.toLocaleString("en-IN") %></span>
                <span class="night">/ night</span>
              </p>
              <a href="/listings/<%= listing._id %>" class="view-link">View details</a>
            </div>

          </div>

        <% } %>
      <% } else { %>
        <!-- ===== EMPTY STATE WITH ADD PROPERTY BUTTON ===== -->
        <div class="listing-grid empty-grid">
          <div class="empty-state">
            <div class="empty-icon">
              <i class="fa-solid fa-magnifying-glass"></i>
            </div>
            <h3>No properties found</h3>
            <p>
              No properties are currently available in this filter.
              Be the first to list your place.
            </p>
            <div class="empty-actions">
              <a href="/listings" class="btn-clear">Clear filters</a>
              <a href="/host" class="btn-add-property">+ Add your property</a>
            </div>
          </div>
        </div>
      <% } %>

    </div>
  </div>

</div>

<!-- Toast popup for wishlist -->
<div id="toast" class="toast"></div>

<!-- ================= STYLES ================= -->
<style>
/* ===== BASE ===== */
body { background:#fff; }
.page-content { padding-bottom:40px; }

/* ===== SEARCH (compact, navbar-sized) ===== */
.search-wrapper {
  background:#fafafa;
  padding:12px 16px;              /* less vertical padding */
}
.search-bar {
  max-width:720px;                /* narrower overall */
  margin:0 auto;
  display:grid;
  grid-template-columns:3fr 1fr 1fr 1.2fr auto;
  gap:6px;
  background:#fff;
  padding:6px 10px;               /* smaller internal padding */
  border-radius:999px;            /* pill but thinner */
  box-shadow:0 2px 10px rgba(0,0,0,.06);
  align-items:center;
}
.search-bar input,
.search-bar select {
  height:34px;                    /* smaller height */
  border-radius:999px;
  border:1px solid #eee;
  padding:0 10px;
  font-size:13px;
}
.search-bar input::placeholder {
  color:#999;
}
.search-bar button {
  height:34px;
  border-radius:999px;
  border:none;
  background:#fe424d;
  color:#fff;
  padding:0 14px;
  font-size:13px;
  display:flex;
  align-items:center;
  gap:6px;
  justify-content:center;
  white-space:nowrap;
}
.search-bar button i {
  font-size:13px;
}
.search-bar .btn-text {
  display:inline-block;
}

/* ===== CATEGORY ===== */
.category-wrapper {
  max-width:1200px;
  margin:16px auto 10px;
  padding:0 16px;
}
.category-scroll {
  display:flex;
  gap:18px;
  overflow-x:auto;
  padding-bottom:12px;
}
.category-scroll::-webkit-scrollbar { display:none; }

.category-pill {
  min-width:110px;
  height:96px;
  background:#fff;
  border-radius:18px;
  box-shadow:0 4px 14px rgba(0,0,0,.08);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:.25s;
}
.category-pill:hover {
  transform:translateY(-4px);
  box-shadow:0 10px 24px rgba(0,0,0,.15);
}
.category-pill.active {
  background:linear-gradient(135deg,#fe424d,#ff6b6b);
  color:#fff;
}
.category-pill .emoji {
  font-size:26px;
  margin-bottom:6px;
}
.category-pill .name {
  font-size:13px;
  font-weight:600;
  text-transform:capitalize;
}

.gst-toggle {
  margin-top:12px;
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:600;
}

/* ===== GRID ===== */
.listing-grid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:24px;
}
.listing-grid.empty-grid {
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:320px;
}

/* ===== CARD ===== */
.listing-card {
  background:#fff;
  border-radius:18px;
  overflow:hidden;
  box-shadow:0 1px 6px rgba(0,0,0,.12);
  transition:.25s;
  position:relative;
}
.listing-card:hover {
  transform:translateY(-4px);
  box-shadow:0 10px 26px rgba(0,0,0,.18);
}

/* Image */
.image-wrapper {
  aspect-ratio:1/1;
  position:relative;
  overflow:hidden;
}
.image-wrapper img {
  width:100%;
  height:100%;
  object-fit:cover;
}

/* Dots */
.image-dots {
  position:absolute;
  bottom:12px;
  width:100%;
  display:flex;
  justify-content:center;
  gap:6px;
}
.image-dots span {
  width:6px;
  height:6px;
  border-radius:50%;
  background:rgba(255,255,255,.6);
}
.image-dots .active { background:#fff; }

/* Heart */
.like-btn {
  position:absolute;
  top:12px;
  right:12px;
  width:32px;
  height:32px;
  border-radius:50%;
  background:#fff;
  border:none;
  box-shadow:0 2px 10px rgba(0,0,0,.25);
  z-index:10;
  display:flex;
  justify-content:center;
  align-items:center;
  cursor:pointer;
}
.like-btn i {
  font-size:16px;
  display:block;
  transition:color .2s;
}
.like-btn.liked i {
  color:#fe424d;
}

/* Body */
.card-body {
  padding:12px 14px 16px;
}
.title {
  font-size:15px;
  font-weight:600;
}
.location {
  font-size:13px;
  color:#717171;
}
.price {
  font-size:15px;
  font-weight:600;
}
.price .night {
  font-size:13px;
  color:#717171;
}
.view-link {
  color:#fe424d;
  font-weight:600;
  text-decoration:none;
}
.view-link:hover { text-decoration:underline; }

/* ===== EMPTY STATE ===== */
.empty-state {
  width:100%;
  max-width:520px;
  margin:0 auto;
  text-align:center;
  color:#444;
}
.empty-icon {
  width:72px;
  height:72px;
  border-radius:50%;
  background:#f6f6f6;
  display:flex;
  align-items:center;
  justify-content:center;
  margin:0 auto 18px;
}
.empty-icon i {
  font-size:30px;
  color:#999;
}
.empty-state h3 {
  font-size:22px;
  margin-bottom:6px;
}
.empty-state p {
  font-size:14px;
  color:#777;
  margin-bottom:20px;
}
.empty-actions {
  display:flex;
  justify-content:center;
  gap:12px;
}
.btn-clear,
.btn-add-property {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:10px 18px;
  border-radius:999px;
  font-size:14px;
  font-weight:600;
  text-decoration:none;
  border:1px solid transparent;
}
.btn-clear {
  background:#fff;
  border-color:#d0d0d0;
  color:#0070f3;
}
.btn-clear:hover {
  background:#f5f5f5;
}
.btn-add-property {
  background:#0f9f4f;
  color:#fff;
}
.btn-add-property:hover {
  background:#0b7a3c;
}

/* Toast popup */
.toast {
  position:fixed;
  left:50%;
  bottom:24px;
  transform:translateX(-50%);
  background:#333;
  color:#fff;
  padding:10px 16px;
  border-radius:999px;
  font-size:14px;
  opacity:0;
  pointer-events:none;
  transition:opacity .25s ease, transform .25s ease;
  z-index:9999;
}
.toast.show {
  opacity:1;
  transform:translateX(-50%) translateY(-6px);
}

/* Mobile */
@media(max-width:768px){
  .search-bar {
    grid-template-columns:1fr;
    max-width:100%;
  }
  .category-pill { min-width:90px;height:88px; }
}
</style>

<!-- ================= SCRIPT ================= -->
<script>
const categories = [
  { key:"", name:"All", emoji:"ðŸ " },
  { key:"trending", name:"trending", emoji:"ðŸ”¥" },
  { key:"rooms", name:"rooms", emoji:"ðŸ›ï¸" },
  { key:"iconic-cities", name:"iconic cities", emoji:"ðŸ™ï¸" },
  { key:"mountains", name:"mountains", emoji:"â›°ï¸" },
  { key:"beaches", name:"beaches", emoji:"ðŸ–ï¸" },
  { key:"castles", name:"castles", emoji:"ðŸ°" },
  { key:"pools", name:"pools", emoji:"ðŸŠ" },
  { key:"lakefront", name:"lakefront", emoji:"ðŸžï¸" },
  { key:"countryside", name:"countryside", emoji:"ðŸŒ¾" },
  { key:"camping", name:"camping", emoji:"â›º" },
  { key:"cabins", name:"cabins", emoji:"ðŸ›–" }
];

const navbar = document.getElementById("categoryNavbar");
const params = new URLSearchParams(window.location.search);
const active = params.get("category") || "";

categories.forEach(cat => {
  const pill = document.createElement("div");
  pill.className = "category-pill" + (cat.key === active ? " active" : "");
  pill.innerHTML = `<div class="emoji">${cat.emoji}</div><div class="name">${cat.name}</div>`;
  pill.onclick = () => {
    cat.key ? params.set("category",cat.key) : params.delete("category");
    window.location.search = params.toString();
  };
  navbar.appendChild(pill);
});

/* Toast helper */
function showToast(message) {
  const toast = document.getElementById("toast");
  if (!toast) return;
  toast.textContent = message;
  toast.classList.add("show");
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(() => {
    toast.classList.remove("show");
  }, 1800);
}

/* Wishlist: toggle filled heart + toast */
document.querySelectorAll(".like-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const icon = btn.querySelector("i");
    const isLiked = btn.classList.toggle("liked");

    if (icon) {
      if (isLiked) {
        icon.classList.remove("fa-regular");
        icon.classList.add("fa-solid");
        showToast("Added to wishlist");
      } else {
        icon.classList.remove("fa-solid");
        icon.classList.add("fa-regular");
        showToast("Removed from wishlist");
      }
    }
  });
});

/* GST */
document.getElementById("gstToggle").onchange = function(){
  document.querySelectorAll(".listing-card").forEach(card=>{
    const base=+card.dataset.price;
    const el=card.querySelector(".price-value");
    el.textContent=this.checked
      ? Math.round(base*1.12).toLocaleString("en-IN")
      : base.toLocaleString("en-IN");
  });
};
</script>
