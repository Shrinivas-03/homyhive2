<%layout("/layouts/boilerplate")%>

<% if (!listing || !listing._id) { %>
  <div class="alert alert-danger">Listing not found or invalid</div>
<% } else { %>

<script>
  const mapToken = "<%=process.env.MAP_TOKEN%>";
  const listing = JSON.parse('<%- JSON.stringify(listing) %>');
</script>

<style>
  .booking-card {
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  .booking-card h5 {
    font-weight: 600;
  }
  .booking-card .price {
    font-size: 1.5rem;
    font-weight: 600;
  }

  /* ===== Airbnb‑style image grid ===== */
  .listing-gallery {
    display: grid;
    grid-template-columns: 2fr 1.3fr 1.3fr;
    grid-template-rows: repeat(2, 180px);
    gap: 8px;
    border-radius: 16px;
    overflow: hidden;
  }
  .listing-gallery-main {
    grid-row: 1 / span 2;
    grid-column: 1 / 2;
  }
  .listing-gallery-item {
    position: relative;
    width: 100%;
    height: 100%;
    cursor: pointer;
  }
  .listing-gallery-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;      /* whole card covered */
    display: block;
  }
  .listing-gallery-more {
    position: absolute;
    right: 10px;
    bottom: 10px;
    padding: 6px 10px;
    border-radius: 999px;
    background: rgba(0,0,0,.6);
    color: #fff;
    font-size: 12px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .no-image-placeholder {
    height: 360px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    background-color:#f8f9fa;
    border-radius:16px;
  }

  /* ===== Fullscreen modal for images ===== */
  .image-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  .image-modal-overlay.open {
    display: flex;
  }
  .image-modal-content {
    max-width: 90vw;
    max-height: 90vh;
  }
  .image-modal-content img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    border-radius: 10px;
    box-shadow: 0 10px 40px rgba(0,0,0,.5);
  }
  .image-modal-close {
    position: absolute;
    top: 18px;
    right: 24px;
    font-size: 26px;
    color: #fff;
    cursor: pointer;
  }

  @media(max-width: 768px){
    .listing-gallery {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: repeat(3, 140px);
    }
    .listing-gallery-main {
      grid-row: 1 / span 2;
      grid-column: 1 / span 2;
    }
  }

  /* ===== Premium Review Styling (Airbnb/OYO Style) ===== */
  .reviews-section {
    margin-top: 3rem;
    padding: 2rem 0;
  }

  .reviews-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .review-card {
    border: 1px solid #e8e8e8;
    border-radius: 12px;
    padding: 1.5rem;
    background: #ffffff;
    transition: all 0.3s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  }

  .review-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
    border-color: #d0d0d0;
  }

  .review-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    gap: 1rem;
  }

  .reviewer-info {
    flex: 1;
    min-width: 0;
  }

  .reviewer-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: #222;
    margin-bottom: 0.25rem;
    word-break: break-word;
  }

  .review-date {
    font-size: 0.85rem;
    color: #999;
  }

  .review-rating {
    margin: 1rem 0;
  }

  .review-rating .starability-result {
    display: inline-block;
    margin: 0;
    font-size: 1.1rem;
  }

  .review-comment {
    color: #555;
    line-height: 1.6;
    font-size: 0.95rem;
    margin: 1rem 0 0 0;
    word-wrap: break-word;
  }

  .no-reviews-message {
    text-align: center;
    padding: 2.5rem;
    background: #f9f9f9;
    border-radius: 12px;
    color: #999;
    margin-bottom: 2rem;
  }

  .no-reviews-message i {
    font-size: 2.5rem;
    color: #ddd;
    margin-bottom: 1rem;
    display: block;
  }

  .review-form-section {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 12px;
    padding: 2.5rem;
    margin-top: 2rem;
  }

  .review-form-section h5 {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: #222;
  }

  .review-form-section .form-label {
    font-weight: 600;
    color: #222;
    margin-bottom: 0.75rem;
  }

  .review-form-section .form-control,
  .review-form-section textarea {
    border: 2px solid #ddd;
    border-radius: 8px;
    padding: 0.75rem;
    font-size: 0.95rem;
    transition: all 0.3s ease;
  }

  .review-form-section .form-control:focus,
  .review-form-section textarea:focus {
    border-color: #ff6b6b;
    box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
    outline: none;
  }

  .review-form-section textarea {
    min-height: 110px;
    resize: vertical;
  }

  .review-form-section small {
    display: block;
    margin-top: 0.5rem;
    color: #666;
    font-size: 0.85rem;
  }

  .review-form-section .btn {
    padding: 0.85rem 2rem;
    font-weight: 600;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
    border: none;
  }

  .review-form-section .btn-dark {
    background-color: #222;
    color: white;
  }

  .review-form-section .btn-dark:hover {
    background-color: #000;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .login-to-review {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-left: 5px solid #1976d2;
    padding: 1.5rem;
    border-radius: 8px;
    margin-top: 2rem;
    font-size: 0.95rem;
    color: #0d47a1;
  }

  .login-to-review i {
    margin-right: 0.75rem;
    color: #1976d2;
  }

  .login-to-review a {
    font-weight: 700;
    color: #1565c0;
    text-decoration: none;
  }

  .login-to-review a:hover {
    text-decoration: underline;
  }

  .starability-slot {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  #rating-feedback {
    margin-top: 0.5rem;
    color: #dc3545 !important;
    font-size: 0.875rem;
    display: block;
  }

  @media(max-width: 768px){
    .reviews-grid {
      grid-template-columns: 1fr;
    }

    .review-form-section {
      padding: 1.5rem;
    }

    .review-card {
      padding: 1.25rem;
    }
  }

</style>

<div class="row mt-3">
  <div class="col-lg-8">
    <h3><%= listing.title %></h3>

    <!-- ===== IMAGE GRID INSTEAD OF CAROUSEL ===== -->
    <% if(listing.images && listing.images.length > 0) { %>
      <div class="listing-gallery" id="listingGallery">
        <% const imgs = listing.images; %>

        <!-- Main large image -->
        <div class="listing-gallery-item listing-gallery-main" data-index="0">
          <img src="<%= imgs[0].url %>" alt="listing image 1">
        </div>

        <!-- Up to four secondary images -->
        <% if (imgs[1]) { %>
          <div class="listing-gallery-item" data-index="1">
            <img src="<%= imgs[1].url %>" alt="listing image 2">
          </div>
        <% } %>
        <% if (imgs[2]) { %>
          <div class="listing-gallery-item" data-index="2">
            <img src="<%= imgs[2].url %>" alt="listing image 3">
          </div>
        <% } %>
        <% if (imgs[3]) { %>
          <div class="listing-gallery-item" data-index="3">
            <img src="<%= imgs[3].url %>" alt="listing image 4">
          </div>
        <% } %>
        <% if (imgs[4]) { %>
          <div class="listing-gallery-item" data-index="4">
            <img src="<%= imgs[4].url %>" alt="listing image 5">
            <% if (imgs.length > 5) { %>
              <div class="listing-gallery-more">
                <i class="fa-regular fa-images"></i>
                <span>Show all photos</span>
              </div>
            <% } %>
          </div>
        <% } %>
      </div>
    <% } else { %>
      <div class="no-image-placeholder">
        <i class="fa-solid fa-image" style="font-size:3rem;color:#6c757d;"></i>
        <p style="margin-top:1rem;color:#6c757d;">No Image Available</p>
      </div>
    <% } %>

    <div class="card show-card listing-card mb-4 mt-3">
      <div class="card-body">
        <p class="card-text">Owned by <i><%= listing.owner ? listing.owner.username : 'Anonymous' %></i></p>
        <p class="card-text"><%= listing.description %></p>
        <p class="card-text"><%= listing.location %>, <%= listing.country %></p>
        <% if(listing.amenities && listing.amenities.length > 0) { %>
          <p class="card-text"><b>Amenities:</b> <%= listing.amenities.join(', ') %></p>
        <% } %>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="booking-card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><span class="price">₹<%= listing.price.toLocaleString("en-IN") %></span> / night</h5>
      </div>
      <form id="booking-form">
        <div class="mb-3">
          <label for="checkIn" class="form-label">Check-in</label>
          <input type="date" id="checkIn" name="checkIn" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="checkOut" class="form-label">Check-out</label>
          <input type="date" id="checkOut" name="checkOut" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="guests" class="form-label">Guests</label>
          <input type="number" id="guests" name="guests" class="form-control" min="1" value="1" required>
        </div>
        <button type="submit" class="btn btn-primary w-100">Reserve</button>
      </form>
    </div>
  </div>
</div>

<div class="row mt-4">
  <div class="col-12">
    <hr>
    <% if(currUser && listing.owner && String(listing.owner._id) === String(currUser._id)) { %>
      <div class="btns mb-3">
        <a href="/listings/<%=listing._id%>/edit" class="btn btn-dark">Edit</a>
        <form method="POST" action="/listings/<%=listing._id%>?_method=DELETE" class="d-inline">
          <button class="btn btn-dark">Delete</button>
        </form>
        <a href="/listings/<%=listing._id%>/promote" class="btn btn-success">Promote</a>
      </div>
    <% } %>
  </div>
</div>

<!-- REVIEWS AND RATINGS SECTION -->
<div class="container mt-5 mb-5">
  <div class="row">
    <div class="col-md-12">
      <h3 class="mb-4">Reviews</h3>
      
      <!-- Debug: Show review count -->
      <div style="background: #f0f0f0; padding: 10px; margin-bottom: 20px; border-radius: 5px;">
        <small style="color: #666;">Reviews found: <%= reviews ? reviews.length : 0 %> | Logged in: <%= currUser ? 'Yes' : 'No' %></small>
      </div>
      
      <!-- Display Reviews -->
      <% if(reviews && reviews.length > 0) { %>
        <div class="row mb-4">
          <% reviews.forEach(review => { %>
            <% if(review && review.rating && review.comment) { %>
              <div class="col-md-6 mb-4">
                <div style="padding: 0; display: flex; flex-direction: column;">
                  <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <!-- User Avatar -->
                    <div style="width: 48px; height: 48px; min-width: 48px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem;">
                      <%= ((review.author_info && review.author_info.username) || 'A')[0].toUpperCase() %>
                    </div>
                    <!-- User Info -->
                    <div style="flex: 1;">
                      <div style="font-weight: 600; margin-bottom: 0.2rem;">
                        <%= (review.author_info && review.author_info.username) || 'Anonymous' %>
                      </div>
                      <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.3rem;">
                        <% 
                          const now = new Date();
                          const reviewDate = new Date(review.created_at);
                          const diffMs = now - reviewDate;
                          const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                          const diffWeeks = Math.floor(diffDays / 7);
                          const diffMonths = Math.floor(diffDays / 30);
                          const diffYears = Math.floor(diffDays / 365);
                          
                          let timeAgo = '';
                          if(diffDays < 1) timeAgo = 'Today';
                          else if(diffDays === 1) timeAgo = '1 day ago';
                          else if(diffDays < 7) timeAgo = diffDays + ' days ago';
                          else if(diffWeeks === 1) timeAgo = '1 week ago';
                          else if(diffWeeks < 4) timeAgo = diffWeeks + ' weeks ago';
                          else if(diffMonths === 1) timeAgo = '1 month ago';
                          else if(diffMonths < 12) timeAgo = diffMonths + ' months ago';
                          else if(diffYears === 1) timeAgo = '1 year ago';
                          else timeAgo = diffYears + ' years ago';
                        %>
                        <%= timeAgo %>
                      </div>
                      <!-- Stars -->
                      <div style="font-size: 0.9rem; color: #333;">
                        <% for(let i = 0; i < review.rating; i++) { %>
                          ★
                        <% } %>
                      </div>
                    </div>
                    <!-- Delete Button -->
                    <% if(currUser && review.author && String(currUser.id) === String(review.author)) { %>
                      <form method="POST" action="/listings/<%=listing._id%>/reviews/<%=review.id%>?_method=DELETE" style="margin: 0;">
                        <button type="submit" class="btn btn-sm btn-link text-danger" style="padding: 0;">
                          <i class="fa-solid fa-trash"></i>
                        </button>
                      </form>
                    <% } %>
                  </div>
                  <!-- Review Comment -->
                  <div style="color: #333; line-height: 1.5; font-size: 0.95rem;">
                    <% 
                      const maxLength = 300;
                      const text = review.comment;
                      const isLong = text.length > maxLength;
                      const displayText = isLong ? text.substring(0, maxLength) + '...' : text;
                    %>
                    <p style="margin: 0; margin-bottom: 0.5rem;" id="review-text-<%= review.id %>">
                      <%= displayText %>
                    </p>
                    <% if(isLong) { %>
                      <a href="#" style="text-decoration: underline; color: #333; cursor: pointer;" onclick="toggleReview(event, '<%= review.id %>', '<%= text.replace(/'/g, "\\'") %>')">
                        Show more
                      </a>
                    <% } %>
                  </div>
                </div>
              </div>
            <% } %>
          <% }); %>
        </div>
        <script>
          function toggleReview(e, reviewId, fullText) {
            e.preventDefault();
            const reviewElement = document.getElementById('review-text-' + reviewId);
            const linkElement = e.target;
            
            if(linkElement.innerText === 'Show more') {
              reviewElement.innerText = fullText;
              linkElement.innerText = 'Show less';
            } else {
              const maxLength = 300;
              const shortText = fullText.substring(0, maxLength) + '...';
              reviewElement.innerText = shortText;
              linkElement.innerText = 'Show more';
            }
          }
        </script>
      <% } else { %>
        <p class="text-muted">No reviews yet. Be the first to review this property!</p>
      <% } %>

      <!-- Review Form -->
      <% if(currUser) { %>
        <div class="mt-5">
          <h5 class="mb-4">Leave a Review</h5>
          <form action="/listings/<%=listing._id%>/reviews" method="POST" id="review-form">
            <div class="mb-3">
              <label class="form-label"><strong>Rating</strong> <span class="text-danger">*</span></label>
              <div class="star-rating" style="font-size: 2rem; cursor: pointer;">
                <input type="hidden" name="review[rating]" id="rating-value" value="0" required>
                <span class="star" data-value="1" style="color: #ddd; margin-right: 0.5rem;">★</span>
                <span class="star" data-value="2" style="color: #ddd; margin-right: 0.5rem;">★</span>
                <span class="star" data-value="3" style="color: #ddd; margin-right: 0.5rem;">★</span>
                <span class="star" data-value="4" style="color: #ddd; margin-right: 0.5rem;">★</span>
                <span class="star" data-value="5" style="color: #ddd; margin-right: 0.5rem;">★</span>
              </div>
              <small id="rating-error" class="text-danger" style="display: none;">Please select a rating</small>
            </div>
            <div class="mb-3">
              <label for="comment" class="form-label"><strong>Comments</strong> <span class="text-danger">*</span></label>
              <textarea name="review[comment]" id="comment" class="form-control" rows="4" placeholder="Share your experience..." required></textarea>
            </div>
            <button type="submit" class="btn btn-outline-secondary">Submit Review</button>
          </form>
        </div>
        
        <script>
          document.querySelectorAll('.star').forEach(star => {
            star.addEventListener('click', function() {
              const rating = this.getAttribute('data-value');
              document.getElementById('rating-value').value = rating;
              document.querySelectorAll('.star').forEach((s, index) => {
                if(index < rating) {
                  s.style.color = '#ffc107';
                } else {
                  s.style.color = '#ddd';
                }
              });
            });
            
            star.addEventListener('mouseover', function() {
              const rating = this.getAttribute('data-value');
              document.querySelectorAll('.star').forEach((s, index) => {
                if(index < rating) {
                  s.style.color = '#ffc107';
                } else {
                  s.style.color = '#ddd';
                }
              });
            });
          });
          
          document.querySelector('.star-rating').addEventListener('mouseleave', function() {
            const currentRating = document.getElementById('rating-value').value;
            document.querySelectorAll('.star').forEach((s, index) => {
              if(index < currentRating) {
                s.style.color = '#ffc107';
              } else {
                s.style.color = '#ddd';
              }
            });
          });
          
          document.getElementById('review-form').addEventListener('submit', function(e) {
            if(document.getElementById('rating-value').value === '0') {
              e.preventDefault();
              document.getElementById('rating-error').style.display = 'block';
            } else {
              document.getElementById('rating-error').style.display = 'none';
            }
          });
        </script>
      <% } else { %>
        <p class="text-muted mt-4"><a href="/login">Log in</a> to leave a review</p>
      <% } %>
    </div>
  </div>
</div>
</div>

<!-- MAP SECTION -->
<div class="row mt-4">
  <div class="col-lg-8 mb-3">
    <h3>Where you'll be</h3>
    <div id="map" style="height: 400px;"></div>
  </div>
</div>

<!-- Fullscreen image modal -->
<div class="image-modal-overlay" id="imageModal">
  <span class="image-modal-close" id="imageModalClose">&times;</span>
  <div class="image-modal-content">
    <img id="imageModalImg" src="" alt="Listing large">
  </div>
</div>

<script>
  document.getElementById('booking-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const checkIn = document.getElementById('checkIn').value;
    const checkOut = document.getElementById('checkOut').value;
    const guests = document.getElementById('guests').value;

    if (checkIn && checkOut && guests) {
      if (new Date(checkIn) >= new Date(checkOut)) {
        alert("Check-out date must be after check-in date.");
        return;
      }
      const url = `/listings/<%=listing._id%>/book?checkIn=${checkIn}&checkOut=${checkOut}&guests=${guests}`;
      window.location.href = url;
    } else {
      alert("Please fill in all booking details.");
    }
  });

  // ===== Review form validation =====
  (function() {
    const reviewForm = document.getElementById('review-form');
    if (!reviewForm) return;

    reviewForm.addEventListener('submit', function(e) {
      const ratingChecked = document.querySelector('input[name="review[rating]"]:checked');
      const ratingValue = ratingChecked ? parseInt(ratingChecked.value) : 0;
      
      if (ratingValue === 0) {
        e.preventDefault();
        e.stopPropagation();
        const feedback = document.getElementById('rating-feedback');
        if (feedback) {
          feedback.style.display = 'block';
        }
        return false;
      }
    });
  })();

  // ===== Image click -> fullscreen modal =====
  (function(){
    const gallery = document.getElementById('listingGallery');
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('imageModalImg');
    const modalClose = document.getElementById('imageModalClose');

    if (!gallery || !modal || !modalImg) return;

    gallery.addEventListener('click', function(e){
      const item = e.target.closest('.listing-gallery-item');
      if (!item) return;
      const img = item.querySelector('img');
      if (!img) return;
      modalImg.src = img.src;
      modal.classList.add('open');
    });

    modalClose.addEventListener('click', function(){
      modal.classList.remove('open');
      modalImg.src = "";
    });

    modal.addEventListener('click', function(e){
      if (e.target === modal) {
        modal.classList.remove('open');
        modalImg.src = "";
      }
    });

    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape' && modal.classList.contains('open')) {
        modal.classList.remove('open');
        modalImg.src = "";
      }
    });
  })();
</script>

<script src="/js/map.js"></script>
<% } %>